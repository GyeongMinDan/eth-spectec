;; ------------------------------------------------------------
;; is_slashable_attestation_data
;; ------------------------------------------------------------
dec $is_slashable_attestation_data(attestationData, attestationData) : bool
def $is_slashable_attestation_data(attd1, attd2) =
  ( ~(attd1 = attd2) /\ $( attd1.TARGET.EPOCH = attd2.TARGET.EPOCH ) )
  \/
  ( $( attd1.SOURCE.EPOCH < attd2.SOURCE.EPOCH ) /\ $( attd2.TARGET.EPOCH < attd1.TARGET.EPOCH ) )

;;
;; is_valid_indexed_attestation
;;
dec $is_valid_indexed_attestation(beaconState, indexedAttestation) : boolean
;; 1. empty list
def $is_valid_indexed_attestation(state, indexedAttestation) = false
  -- if validatorIndex_indices* = indexedAttestation.ATTESTING_INDICES
  -- if $( |validatorIndex_indices*| = 0 )

;; 2. not sorted
def $is_valid_indexed_attestation(state, indexedAttestation) = false
  -- if validatorIndex_indices* = indexedAttestation.ATTESTING_INDICES
  -- if $to_set_<validatorIndex>(validatorIndex_indices*) = validatorIndex_set*
  -- if $sort_<validatorIndex>(validatorIndex_set*)    = validatorIndex_sorted*
  -- if ~( validatorIndex_sorted* = validatorIndex_indices* )

;; 3. if is true
def $is_valid_indexed_attestation(state, indexedAttestation) = true
  -- if validatorIndex_indices* = indexedAttestation.ATTESTING_INDICES
  -- if $to_set_<validatorIndex>(validatorIndex_indices*) = validatorIndex_set*
  -- if $sort_<validatorIndex>(validatorIndex_set*) = validatorIndex_sorted*
  -- if $( |validatorIndex_sorted*| > 0 )
  -- if validatorIndex_sorted* = validatorIndex_indices*
  -- if (state.VALIDATORS[validatorIndex_indices].PUBKEY = blsPubkey_pk)*
  -- if $get_domain(state, $DOMAIN_BEACON_ATTESTER, indexedAttestation.DATA.TARGET.EPOCH) = domain_att
  -- if $compute_signing_root_attestationData(indexedAttestation.DATA, domain_att) = root_sign
  -- if $bls_fast_aggregate_verify(blsPubkey_pk*, root_sign, indexedAttestation.SIGNATURE) = true


;; =========================
;; Generic fold 
;; =========================
dec $fold_<X, Y>(def $fold_func(X, Y): X, X, Y*) : X
def $fold_<X, Y>(def $fold_func, X, eps) = X
def $fold_<X, Y>(def $fold_func, X, Y_h :: Y_t*)
= $fold_<X, Y>(def $fold_func, $fold_func(X, Y_h), Y_t*)


;; is_slashable?
dec $is_slashable_now(validatorIndex, beaconState) : boolean

def $is_slashable_now(validatorIndex_vi, state) = true
  -- if $(validatorIndex_vi < |state.VALIDATORS|)
  -- if state.VALIDATORS[validatorIndex_vi] = validator_v
  -- if $get_current_epoch(state) = epoch_cur
  -- if $is_slashable_validator(validator_v, epoch_cur) = true

def $is_slashable_now(validatorIndex_vi, state) = false
  -- otherwise

;; if is_slashable -> slash
dec $slash_if_eligible(beaconState, validatorIndex) : beaconState

def $slash_if_eligible(state, validatorIndex_vi) = state_slashed
  -- if $is_slashable_now(validatorIndex_vi, state) = true
  -- if state_slashed = $slash_validator(state, validatorIndex_vi, eps)

def $slash_if_eligible(state, validatorIndex_vi) = state
  -- otherwise

;; 리스트 전체에 적용: fold_
dec $apply_slashes(beaconState, validatorIndex*) : beaconState
def $apply_slashes(state, validatorIndex_sorted*) = state_after
  -- if $fold_<beaconState, validatorIndex>(
         def $slash_if_eligible,
         state,
         validatorIndex_sorted*
       ) = state_after